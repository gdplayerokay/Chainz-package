#!/usr/bin/env bash

VERSION="Chainz 1.2 (Major Update)"
cmd="$1"
pkg="$2"

# --------------------------
# Update notes (notes)
# --------------------------
if [[ "$cmd" == "notes" ]]; then
    echo "These are the 1.1.2 update notes:"
    echo "1. New fuzzy find for removal and installation with fzf"
    echo "2. Added colors to invalid options"
    echo "3. Added installation guides for Dependencies"
    echo "4. Update notes in /usr/bin/chainz and if you run 'chainz notes'"
    echo "5. Fixed help menu with new options"
    echo "6. Removal of flatpak and Paru from bugs"
    exit 1;
fi

# --------------------------
# Check Dependencies
# --------------------------
command -v fzf    >/dev/null 2>&1 || {
    echo "fzf not installed"
    echo "To install fzf run:"
    echo "sudo pacman -S fzf"
    exit 1;
}

# --------------------------
# Version
# --------------------------
if [[ "$cmd" == "-v" || "$cmd" == "--version" || "$cmd" == "version" ]]; then
    echo "$VERSION"
    exit 0
fi

# --------------------------
#  Interactive Mode
# --------------------------
if [[ -z "$cmd" ]]; then
    echo "What do you want to manage?"
    echo "1) Install packages"
    echo "2) Remove packages"
    echo "3) Upgrade packages"
    read -p "> " action

    case "$action" in
        1)
            cmd="-I"
            ;;
        2)
            cmd="-R"
            ;;
        3)
            cmd="-U"
            ;;
        *)
            echo -e "\e[31mInvalid Choice"
            exit 1
            ;;
    esac
fi

# -------------------------
# Update/Upgrade (-U)
# -------------------------
if [[ "$cmd" == "-U" || "$cmd" == "upgrade" ]]; then
    echo "=== Chainz System Upgrade ==="
    echo

    echo "→ Updating pacman packages..."
    sudo pacman -Syu --noconfirm

    echo
    echo "→ Updating Yay (AUR) packages..."
    yay -Syu --noconfirm

    echo
    echo "=== All package managers updated ==="
    exit 0
fi

# -------------------------
# Help (--help)
# -------------------------
if [[ "$cmd" == "--help" || "$cmd" == "-h" || "$cmd" == "help" ]]; then
    echo "Chainz - Universal Arch Package Manager Wrapper"
    echo "Chainz Version: $VERSION"
    echo
    echo "Usage:"
    echo "  chainz -I <package>        Install a package"
    echo "  chainz -R <package>        Remove a package"
    echo "  chainz -U                  Update all packages"
    echo "  chainz -h                  Show this help"
    echo "  chainz -v                  Show version"
    echo "  chainz notes               Show update notes"
    echo
    echo "Long Usage:"
    echo "  chainz install <packages>  Same as -I"
    echo "  chainz remove <packages>   Same as -R"
    echo "  chainz upgrade             Same as -U"
    echo "  chainz help                same as -h"
    echo "  chainz version             same as -v"
    echo
    echo "Examples:"
    echo "  chainz -I firefox"
    echo "  chainz -R firefox"
    echo "  chainz -U"
    echo "  chainz -h"
    echo "  chainz -v"
    echo "  chainz notes"
    exit 0
fi

# -------------------------
# Remove (-R)
# -------------------------
if [[ "$cmd" == "-R" || "$cmd" == "remove" ]]; then
    # List installed pacman packages
    mapfile -t pacman_pkgs < <(pacman -Q | awk '{print $1}')
    if [[ ${#pacman_pkgs[@]} -eq 0 ]]; then
        echo "No pacman packages installed."
        exit 1
    fi

    # Check if fzf is installed
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf not found. Installing it..."
        sudo pacman -S --noconfirm fzf
    fi

    # Use fzf to select package
    echo "Select Pacman package to remove (start typing to fuzzy search):"
    pkg_to_remove=$(printf "%s\n" "${pacman_pkgs[@]}" | fzf --prompt="Package> ")

    if [[ -z "$pkg_to_remove" ]]; then
        echo "No package selected."
        exit 1
    fi

    echo "Removing package: $pkg_to_remove"
    sudo pacman -R "$pkg_to_remove"
    exit 0
fi

# -------------------------
# Install (-I)
# -------------------------
if [[ "$cmd" == "-I" || "$cmd" == "install" ]]; then

    # Check if fzf is installed
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf not found. Installing it..."
        sudo pacman -S --noconfirm fzf
    fi

    # Ask which package manager to use
    echo "Select the package manager:"
    manager=$(printf "%s\n" "Pacman" "Yay" | fzf --prompt="Package manager> " --height 10% --reverse)

    if [[ -z "$manager" ]]; then
        echo "No package manager selected."
        exit 1
    fi

    # Fetch package list and fuzzy find
    case "$manager" in
        Pacman)
            echo "Fetching Pacman packages..."
            pkgs=($(pacman -Sl | awk '{print $2}'))
            ;;
        Yay)
            echo "Fetching Yay (AUR) packages..."
            pkgs=($(yay -Ssq))
            ;;
        Paru)
            echo "Fetching Paru (AUR) packages..."
            # Use paru -Ss without a query and extract package names
            pkgs=($(paru -S -Q --aur --list | awk '{print $1}'))
            # Alternative: `paru -Ssq <search>` won't work without a search term
            ;;
        *)
            echo "Invalid package manager."
            exit 1
            ;;
    esac

    if [[ ${#pkgs[@]} -eq 0 ]]; then
        echo "No packages found for $manager."
        exit 1
    fi

    # Fuzzy select the package
    pkg=$(printf "%s\n" "${pkgs[@]}" | fzf --prompt="Select package> " --height 20% --reverse)
    if [[ -z "$pkg" ]]; then
        echo "No package selected."
        exit 1
    fi

    # Install the selected package
    echo "Installing $pkg via $manager..."
    case "$manager" in
        Pacman)
            sudo pacman -S "$pkg"
            ;;
        Yay)
            yay -S "$pkg"
            ;;
        Paru)
            paru -S "$pkg"
            ;;
    esac

    exit 0
fi

#!/usr/bin/env bash

VERSION="Chainz 1.1.1 (Hotfix)"
cmd="$1"
pkg="$2"

# --------------------------
# Check Dependencies
# --------------------------
command -v pacman >/dev/null 2>&1 || { echo "Pacman not installed"; exit 1; }
command -v yay    >/dev/null 2>&1 || { echo "Yay not installed"; exit 1; }
command -v paru   >/dev/null 2>&1 || { echo "Paru not installed"; exit 1; }
command -v flatpak >/dev/null 2>&1 || { echo "Flatpak not installed"; exit 1; }

# --------------------------
# Version
# --------------------------
if [[ "$cmd" == "-v" || "$cmd" == "--version" || "$cmd" == "version" ]]; then
    echo "$VERSION"
    exit 0
fi

# --------------------------
#  Interactive Mode
# --------------------------
if [[ -z "$cmd" ]]; then
    echo "What do you want to do?"
    echo "1) Install a package"
    echo "2) Remove a package"
    echo "3) Upgrade all packages"
    read -p "> " action

    case "$action" in
        1)
            read -p "Enter package name to install: " pkg
            cmd="-I"
            ;;
        2)
            read -p "Enter package name to remove: " pkg
            cmd="-R"
            ;;
        3)
            cmd="-U"
            ;;
        *)
            echo "Invalid selection."
            exit 1
            ;;
    esac
fi

# -------------------------
# Update/Upgrade (-U)
# -------------------------
if [[ "$cmd" == "-U" || "$cmd" == "upgrade" ]]; then
    echo "=== ðŸª¢ Chainz System Upgrade ==="
    echo

    echo "â†’ Updating pacman packages..."
    sudo pacman -Syu --noconfirm

    echo
    echo "â†’ Updating Yay (AUR) packages..."
    yay -Syu --noconfirm

    echo
    echo "â†’ Updating Paru (AUR) packages..."
    paru -Syu --noconfirm

    echo
    echo "â†’ Updating Flatpak packages..."
    flatpak update -y

    echo
    echo "=== âœ” All package managers updated ==="
    exit 0
fi

# -------------------------
# Help (--help)
# -------------------------
if [[ "$cmd" == "--help" || "$cmd" == "-h" || "$cmd" == "help" ]]; then
    echo "Chainz - Universal Arch Package Manager Wrapper"
    echo "Chainz Version: $VERSION"
    echo
    echo "Usage:"
    echo "  chainz -I <package>        Install a package"
    echo "  chainz -R <package>        Remove a package"
    echo "  chainz -U                  Update all packages"
    echo "  chainz -h                  Show this help"
    echo "  chainz -v                  Show version"
    echo
    echo "Examples:"
    echo "  chainz -I firefox"
    echo "  chainz -R firefox"
    echo "  chainz -U"
    echo "  chainz -v"
    exit 0
fi

# -------------------------
# Remove (-R)
# -------------------------
if [[ "$cmd" == "-R" || "$cmd" == "remove" ]]; then
    if [[ -z "$pkg" ]]; then
        echo "Usage: chainz -R <package>"
        exit 1
    fi

    echo "Where do you want to remove from?"
    echo "1) Pacman"
    echo "2) Yay (AUR)"
    echo "3) Flatpak"
    read -p "> " choice

    case "$choice" in
        1) sudo pacman -R "$pkg" ;;
        2) yay -R "$pkg" ;;
        3) flatpak uninstall -y "$pkg" ;;
        *) echo "Invalid option" ;;
    esac
    exit 0
fi

# -------------------------
# Install (-I)
# -------------------------
if [[ "$cmd" == "-I" || "$cmd" == "install" ]]; then
    if [[ -z "$pkg" ]]; then
        echo "Usage: chainz -I <package>"
        exit 1
    fi

    echo "Searching for '$pkg'â€¦"

    # ---- Pacman search ----
    pac_results=$(pacman -Ss "$pkg" | grep -E "^[a-z0-9]" | cut -d' ' -f1)
    echo "Pacman:"
    echo "$pac_results"
    echo

    # ---- Yay search ----
    yay_results=($(yay -Ss "$pkg" | awk '/^aur\// {print $1}'))
    echo "Yay:"
    i=1
    for r in "${yay_results[@]}"; do
        echo "$i) $r"
        ((i++))
    done
    echo

    # ---- Paru search ----
    paru_results=($(paru -Ss "$pkg" | awk '/^aur\// {print $1}'))
    echo "Paru:"
    i=1
    for r in "${paru_results[@]}"; do
        echo "$i) $r"
        ((i++))
    done
    echo

    # ---- Flatpak search ----
    flat_results=$(flatpak search "$pkg" | awk 'NR>1 {print $1}')
    echo "Flatpak:"
    echo "$flat_results"
    echo

    echo "Where do you want to install from?"
    echo "1) Pacman"
    echo "2) Yay (AUR)"
    echo "3) Paru (AUR)"
    echo "4) Flatpak"
    read -p "> " choice

    case "$choice" in
        1)
            sudo pacman -S "$pkg"
            ;;

        2)
            # Yay AUR selection
            if [[ ${#yay_results[@]} -eq 0 ]]; then
                echo "No AUR packages found via Yay."
                exit 1
            fi
            echo "Select AUR package number:"
            read -p "> " yayno
            index=$((yayno - 1))
            if [[ $index -lt 0 || $index -ge ${#yay_results[@]} ]]; then
                echo "Invalid selection."
                exit 1
            fi
            yaypkg="${yay_results[$index]}"
            yay -S "$yaypkg"
            ;;

        3)
            # Paru AUR selection
            if [[ ${#paru_results[@]} -eq 0 ]]; then
                echo "No AUR packages found via Paru."
                exit 1
            fi
            echo "Select AUR package number:"
            read -p "> " parurno
            index=$((parurno - 1))
            if [[ $index -lt 0 || $index -ge ${#paru_results[@]} ]]; then
                echo "Invalid selection."
                exit 1
            fi
            parupkg="${paru_results[$index]}"
            paru -S "$parupkg"
            ;;

        4)
            flatpak install -y "$pkg"
            ;;

        *)
            echo "Invalid option"
            ;;
    esac

    exit 0
fi

